<!DOCTYPE html>
<html>
<head>
<title>Trading - Roj Bachat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    margin:0;font-family:Arial;background:#f4f6f9;
}
.header{
    background:#007bff;padding:18px;color:white;
    text-align:center;font-size:22px;font-weight:bold;
}
.card{
    background:white;margin:15px;padding:20px;
    border-radius:12px;box-shadow:0 2px 6px #0002;
}
.label{font-size:16px;margin-bottom:6px;}
.input{
    width:100%;padding:10px;font-size:16px;
    border:1px solid #ccc;border-radius:8px;margin-top:5px;
}
.btn{
    width:48%;padding:12px;font-size:18px;margin-top:15px;
    border-radius:10px;border:none;color:white;
}
.buy-btn{background:#28a745;}
.sell-btn{background:#dc3545;}
.row{display:flex;justify-content:space-between;}
.price{color:#007bff;font-weight:bold;font-size:20px;}
.holding-box{
    background:#fff;padding:15px;border-radius:12px;
    box-shadow:0 2px 5px #0002;margin-top:15px;
}
.h-item{padding:8px 0;border-bottom:1px solid #ddd;font-size:16px;}

.loaderBox{
    text-align:center;padding:40px;font-size:20px;color:#444;
}
</style>
</head>

<body>

<!-- ===== LOADER (AUTH KE LOAD HONE TAK) ===== -->
<div id="loader" class="loaderBox">Loading...</div>

<!-- ===== MAIN UI (Initially Hidden) ===== -->
<div id="mainContent" style="display:none;">

<div class="header">Trading Market</div>

<div class="card">
    <label class="label">Select Commodity</label>
    <select id="commodity" class="input"></select>

    <p class="price" id="currentPrice">Price: ₹0</p>

    <label class="label">Quantity (KG)</label>
    <input type="number" id="qty" class="input" placeholder="Enter KG">

    <div class="row">
        <button class="btn buy-btn" onclick="buyNow()">BUY</button>
        <button class="btn sell-btn" onclick="sellNow()">SELL</button>
    </div>
</div>

<div class="card holding-box">
    <h3>Your Holdings</h3>
    <div id="holdings">No holdings yet</div>

    <h3 style="margin-top:15px;">Profit / Loss</h3>
    <h2 id="plValue">₹0.00</h2>
</div>

</div> <!-- mainContent end -->

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ------------------ FIREBASE CONFIG ------------------
const firebaseConfig = {
    apiKey: "XXXX",
    authDomain: "XXXX",
    projectId: "XXXX",
    storageBucket: "XXXX",
    messagingSenderId: "XXXX",
    appId: "XXXX"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

let uid = null;

// ================== SAFE AUTH CHECK (NO REDIRECT BUG) ==================
auth.onAuthStateChanged((user) => {
    if (!user) {
        window.location.href = "index.html"; // only if no login
        return;
    }

    uid = user.uid;

    // Show UI safely
    document.getElementById("loader").style.display = "none";
    document.getElementById("mainContent").style.display = "block";

    loadCommodities();
    loadHoldings();
});

// ---------------- LOAD COMMODITIES ----------------
function loadCommodities() {
    db.collection("commodities").onSnapshot(snap => {
        let html = "";
        snap.forEach(doc => {
            html += `<option value="${doc.id}">${doc.id}</option>`;
        });
        commodity.innerHTML = html;
        updatePrice();
    });
}

commodity.addEventListener("change", updatePrice);

function updatePrice() {
    let name = commodity.value;
    db.collection("commodities").doc(name).get().then(d => {
        currentPrice.innerHTML = "Price: ₹" + d.data().price;
    });
}

// ---------------- BUY FUNCTION ----------------
function buyNow(){
    let qty = Number(qtyInput.value);
    if(qty<=0){ alert("Enter valid KG"); return; }

    let name = commodity.value;

    db.collection("commodities").doc(name).get().then(doc=>{
        let price = doc.data().price;
        let cost = qty * price;

        db.collection("wallets").doc(uid).get().then(w=>{
            let bal = w.data().balance;

            if(bal < cost){
                alert("Not enough balance");
                return;
            }

            db.collection("wallets").doc(uid).update({
                balance: bal - cost
            });

            db.collection("holdings")
            .doc(uid).collection("items").doc(name).get().then(h=>{
                let oldQty = h.exists ? h.data().qty : 0;

                db.collection("holdings")
                .doc(uid).collection("items").doc(name).set({
                    qty: oldQty + qty
                });
            });

            alert("Bought Successfully!");
        });
    });
}

// ---------------- SELL FUNCTION ----------------
function sellNow(){
    let qty = Number(qtyInput.value);
    if(qty<=0){ alert("Enter valid KG"); return; }

    let name = commodity.value;

    db.collection("holdings").doc(uid).collection("items").doc(name).get().then(h=>{
        if(!h.exists || h.data().qty < qty){
            alert("Not enough quantity!");
            return;
        }

        let remaining = h.data().qty - qty;

        db.collection("holdings").doc(uid).collection("items").doc(name).update({
            qty: remaining
        });

        db.collection("commodities").doc(name).get().then(c=>{
            let price = c.data().price;
            let credit = qty * price;

            db.collection("wallets").doc(uid).get().then(w=>{
                let bal = w.data().balance;
                db.collection("wallets").doc(uid).update({
                    balance: bal + credit
                });

                alert("Sold Successfully!");
            });
        });
    });
}

// ---------------- HOLDINGS + PROFIT LOSS ----------------
function loadHoldings(){
    db.collection("holdings").doc(uid).collection("items").onSnapshot(snap=>{
        let html = "";
        let totalPL = 0;

        if(snap.empty){
            holdings.innerHTML = "No holdings yet";
            return;
        }

        snap.forEach(async(d)=>{
            let qty = d.data().qty;

            let c = await db.collection("commodities").doc(d.id).get();
            let price = c.data().price;

            let pl = qty * price;
            totalPL += pl;

            html += `<div class='h-item'>${d.id} — ${qty} KG × ₹${price}</div>`;
        });

        holdings.innerHTML = html;
        plValue.innerHTML = "₹ " + totalPL.toFixed(2);
    });
}
</script>

</body>
    </html>
