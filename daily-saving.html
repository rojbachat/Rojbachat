<!DOCTYPE html>
<html>
<head>
<title>Daily Saving – Live Agriculture Prices</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial;
    margin: 0;
    background: #f4f6f9;
    padding: 15px;
}

h2 {
    text-align: center;
    color: #2D1052;
}

.card {
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

input, select {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

.item {
    padding: 10px 0;
    border-bottom: 1px solid #ddd;
}

.item:last-child {
    border-bottom: none;
}

.label { font-weight: bold; color:#2D1052; }
.value { color: #333; }
</style>

</head>
<body>

<h2>Live Agriculture Market Prices</h2>

<!-- Search Bar -->
<div class="card">
    <input type="text" id="searchBox" placeholder="Search commodity..." onkeyup="applyFilters()">
    
    <select id="commodityFilter" onchange="applyFilters()">
        <option value="">Filter by Commodity</option>
    </select>
</div>

<!-- Live Data -->
<div id="dataBox" class="card">
    Loading latest prices...
</div>

<!-- Graph Box -->
<div class="card">
    <h3>Price Graph (Modal Price)</h3>
    <canvas id="priceChart" height="200"></canvas>
</div>

<!-- Firebase Save -->
<div class="card">
    <h3>Save Item</h3>
    <button onclick="saveToFirebase()">Save Today’s Prices</button>
    <p id="saveMsg"></p>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

<script>
// ---------------- YOUR API DETAILS ----------------
const API_KEY = "579b464db66ec23bdd000001ca5d4645524f4e3e6741d332ef07ac4f";
const RESOURCE_ID = "9ef84268-d588-465a-a308-a864a43d0070";

let fullData = [];
let chart;

// ---------------- FIREBASE INIT ----------------
const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "ID",
    appId: "APP_ID"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------- FETCH MARKET RATES ----------------
async function loadMarketRates() {
    try {
        const url = `https://api.data.gov.in/resource/${RESOURCE_ID}?api-key=${API_KEY}&format=json&limit=50`;

        const response = await fetch(url);
        const data = await response.json();

        fullData = data.records;

        // Fill dropdown
        const compSet = new Set();
        fullData.forEach(x => compSet.add(x.commodity));

        compSet.forEach(c => {
            document.getElementById("commodityFilter").innerHTML += `<option value="${c}">${c}</option>`;
        });

        renderData(fullData);
        drawGraph(fullData);

    } catch (err) {
        document.getElementById("dataBox").innerHTML = "Failed to load data!";
        console.log(err);
    }
}

loadMarketRates();

// ---------------- SEARCH + FILTER ----------------
function applyFilters() {
    const searchText = document.getElementById("searchBox").value.toLowerCase();
    const selectedCommodity = document.getElementById("commodityFilter").value;

    let filtered = fullData.filter(item => 
        (item.commodity.toLowerCase().includes(searchText)) &&
        (selectedCommodity === "" || item.commodity === selectedCommodity)
    );

    renderData(filtered);
    drawGraph(filtered);
}

// ---------------- RENDER PRICE LIST ----------------
function renderData(list) {
    let html = "";

    list.forEach(item => {
        let perKg = (item.modal_price / 100).toFixed(2); // Convert to per KG

        html += `
            <div class="item">
                <div><span class="label">Commodity:</span> ${item.commodity}</div>
                <div><span class="label">Variety:</span> ${item.variety}</div>
                <div><span class="label">Market:</span> ${item.market}</div>
                <div><span class="label">Modal Price:</span> ₹${item.modal_price}</div>
                <div><span class="label">Per Kg (Approx):</span> ₹${perKg}</div>
            </div>
        `;
    });

    document.getElementById("dataBox").innerHTML = html;
}

// ---------------- GRAPH ----------------
function drawGraph(list) {
    const labels = list.map(x => x.commodity);
    const prices = list.map(x => x.modal_price);

    if (chart) chart.destroy();

    const ctx = document.getElementById("priceChart").getContext("2d");

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Modal Price",
                data: prices,
                borderWidth: 2
            }]
        }
    });
}

// ---------------- SAVE TO FIREBASE ----------------
async function saveToFirebase() {
    try {
        await db.collection("daily_prices").add({
            date: new Date().toLocaleString(),
            items: fullData
        });

        document.getElementById("saveMsg").innerText = "Saved Successfully ✔";
    } catch (e) {
        document.getElementById("saveMsg").innerText = "Error saving!";
    }
}
</script>

</body>
        </html>
